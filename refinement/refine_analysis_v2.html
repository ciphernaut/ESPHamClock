<!DOCTYPE html>
<html>

<head>
    <title>VOACAP Vision Analysis Bridge</title>
    <style>
        body {
            font-family: sans-serif;
            background: #222;
            color: #eee;
            padding: 20px;
        }

        .images {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        img {
            border: 1px solid #444;
            width: 400px;
        }

        pre {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #status {
            color: #4caf50;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>ðŸ“¡ VOACAP Vision Refinement</h1>
    <div id="status">Starting Analysis...</div>

    <div class="images">
        <div>
            <h3>Ground Truth</h3>
            <img id="gt" src="REPLACE_GT">
        </div>
        <div>
            <h3>Local Implementation</h3>
            <img id="local" src="REPLACE_LOCAL">
        </div>
    </div>

    <h3>LLM Vision Feedback:</h3>
    <pre id="response">Waiting for API response...</pre>

    <script>
        async function analyze() {
            try {
                document.getElementById('status').innerText = 'Starting...';
                const gtBase64 = document.getElementById('gt').src.split(',')[1];
                const localBase64 = document.getElementById('local').src.split(',')[1];

                document.getElementById('status').innerText = 'Calling LM Studio...';

                const payload = {
                    model: "qwen/qwen3-vl-4b",
                    messages: [
                        {
                            role: "user",
                            content: [
                                { type: "text", text: "Analyze these two VOACAP propagation maps for the same frequency. Image 1 is the Ground Truth. Image 2 is our Local implementation. Note that Image 1 has geographical outlines while Image 2 is just the raw propagation data. Focus on the SHAPE and DISTRIBUTION of the propagation zones. Our local model (Image 2) is currently a crude blob. How should we change the distance or solar position math to match the complex corridors seen in Image 1?" },
                                { type: "image_url", image_url: { url: `data:image/png;base64,${gtBase64}` } },
                                { type: "image_url", image_url: { url: `data:image/png;base64,${localBase64}` } }
                            ]
                        }
                    ],
                    temperature: 0.2
                };

                const resp = await fetch('http://127.0.0.1:1234/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await resp.json();
                if (data.choices && data.choices[0]) {
                    document.getElementById('response').innerText = data.choices[0].message.content;
                    document.getElementById('status').innerText = 'Analysis Complete.';
                } else {
                    document.getElementById('response').innerText = JSON.stringify(data, null, 2);
                    document.getElementById('status').innerText = 'API Error.';
                }
            } catch (err) {
                document.getElementById('response').innerText = 'Error: ' + err.message;
                document.getElementById('status').innerText = 'Analysis Failed.';
            }
        }
        window.onload = analyze;
    </script>
</body>

</html>